import os
import sys
import logging
import subprocess
from datetime import datetime
from PyQt5.QtWidgets import (QWidget, QVBoxLayout, QLabel, QListWidget, 
                            QHBoxLayout, QPushButton, QSplitter, QPlainTextEdit,
                            QMessageBox)
from PyQt5.QtCore import QThread, pyqtSignal, QFileSystemWatcher, QTimer, Qt
from PyQt5.QtGui import QTextCharFormat, QColor, QTextCursor

# ãƒ­ã‚¬ãƒ¼ã®è¨­å®š
logging.basicConfig(level=logging.DEBUG, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

class DirectoryWatcher(QThread):
    directory_changed = pyqtSignal(str)

    def __init__(self, directory):
        super().__init__()
        self.directory = directory
        self.watcher = QFileSystemWatcher([self.directory])
        self.watcher.directoryChanged.connect(self.on_directory_changed)
        logger.debug(f"DirectoryWatcher initialized with directory: {directory}")

    def on_directory_changed(self, path):
        logger.debug(f"Directory changed: {path}")
        self.directory_changed.emit(path)

    def update_directory(self, new_directory):
        logger.debug(f"Updating directory watcher from {self.directory} to {new_directory}")
        if self.watcher.directories():
            self.watcher.removePaths(self.watcher.directories())
        self.directory = new_directory
        self.watcher.addPath(new_directory)

class DirectoryWatchTab(QWidget):
    def __init__(self):
        super().__init__()
        self.setObjectName("directory_watch_tab")
        logger.debug("Initializing DirectoryWatchTab")
        
        # ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®è¨­å®š
        self.main_layout = QVBoxLayout()
        self.main_layout.setContentsMargins(10, 10, 10, 10)
        self.main_layout.setSpacing(10)
        self.setLayout(self.main_layout)
        
        # æƒ…å ±ã‚¨ãƒªã‚¢ã®è¨­å®š
        info_layout = QHBoxLayout()
        self.time_label = QLabel(f"UTC: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')}")
        self.user_label = QLabel("User: GingaDza")
        info_layout.addWidget(self.time_label)
        info_layout.addStretch()
        info_layout.addWidget(self.user_label)
        self.main_layout.addLayout(info_layout)
        
        # ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ©ãƒ™ãƒ«ã®è¿½åŠ 
        self.debug_label = QLabel("ãƒ‡ãƒãƒƒã‚°æƒ…å ±: åˆæœŸåŒ–ä¸­...")
        self.debug_label.setStyleSheet("color: blue;")
        self.main_layout.addWidget(self.debug_label)
        
        # æƒ…å ±ãƒ©ãƒ™ãƒ«ã®è¿½åŠ 
        self.info_label = QLabel("ç›£è¦–ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é¸æŠã—ã¦ãã ã•ã„")
        self.main_layout.addWidget(self.info_label)

        # ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ã®ä½œæˆï¼ˆæ°´å¹³åˆ†å‰²ï¼‰
        self.main_splitter = QSplitter(Qt.Horizontal)
        self.main_layout.addWidget(self.main_splitter)
        
        # ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ãŒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å ã‚ã‚‹ã‚ˆã†ã«è¨­å®š
        self.main_layout.setStretch(1, 1)

        # å·¦å´ã®ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
        self.left_widget = QWidget()
        self.left_layout = QVBoxLayout(self.left_widget)
        self.left_layout.setContentsMargins(5, 5, 5, 5)
        self.left_layout.setSpacing(5)

        # ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®è¿½åŠ 
        self.dir_list = QListWidget()
        self.dir_list.setMinimumHeight(400)  # æœ€å°ã®é«˜ã•ã‚’è¨­å®š
        self.left_layout.addWidget(self.dir_list)

        # ãƒœã‚¿ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®è¨­å®š
        button_layout = QHBoxLayout()
        button_layout.setSpacing(10)
        
        self.start_watch_button = QPushButton("ç›£è¦–é–‹å§‹")
        self.stop_watch_button = QPushButton("ç›£è¦–åœæ­¢")
        self.debug_button = QPushButton("ãƒ‡ãƒãƒƒã‚°æƒ…å ±")
        self.debug_button.clicked.connect(self.show_debug_info)
        
        button_layout.addWidget(self.start_watch_button)
        button_layout.addWidget(self.stop_watch_button)
        button_layout.addWidget(self.debug_button)
        self.left_layout.addLayout(button_layout)

        # å³å´ã®ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
        self.right_widget = QWidget()
        self.right_layout = QVBoxLayout(self.right_widget)
        self.right_layout.setContentsMargins(5, 5, 5, 5)
        self.right_layout.setSpacing(5)

        # ãƒ„ãƒªãƒ¼ãƒ“ãƒ¥ãƒ¼ã®ãƒ©ãƒ™ãƒ«ã¨ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
        self.tree_label = QLabel("ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ„ãƒªãƒ¼")
        self.right_layout.addWidget(self.tree_label)

        self.tree_output = QPlainTextEdit()
        self.tree_output.setReadOnly(True)
        self.tree_output.setMinimumHeight(400)  # æœ€å°ã®é«˜ã•ã‚’è¨­å®š
        self.right_layout.addWidget(self.tree_output)

        # æ›´æ–°ãƒœã‚¿ãƒ³
        self.refresh_button = QPushButton("ğŸ”„ æ›´æ–°")
        self.refresh_button.clicked.connect(self.manual_refresh)
        self.right_layout.addWidget(self.refresh_button)

        # ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ã«ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’è¿½åŠ 
        self.main_splitter.addWidget(self.left_widget)
        self.main_splitter.addWidget(self.right_widget)
        
        # ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ã®åˆæœŸã‚µã‚¤ã‚ºæ¯”ç‡ã‚’è¨­å®šï¼ˆ1:1ï¼‰
        self.main_splitter.setStretchFactor(0, 1)
        self.main_splitter.setStretchFactor(1, 1)

        # è¨­å®šã‚¿ãƒ–ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
        self.directory = self.get_app_directory()
        logger.debug(f"Initial directory from settings: {self.directory}")
        if not self.directory:
            self.directory = os.getcwd()  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½¿ç”¨
            logger.debug(f"Using current working directory as fallback: {self.directory}")
        self.debug_label.setText(f"ãƒ‡ãƒãƒƒã‚°æƒ…å ±: åˆæœŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª = {self.directory}")

        # ç›£è¦–ã®è¨­å®š
        self.watcher_thread = DirectoryWatcher(self.directory)
        self.watcher_thread.directory_changed.connect(self.update_directory_list)
        self.watcher_thread.start()

        # ã‚·ã‚°ãƒŠãƒ«æ¥ç¶š
        self.start_watch_button.clicked.connect(self.start_watching)
        self.stop_watch_button.clicked.connect(self.stop_watching)

        # åˆæœŸåŒ–
        self.previous_snapshot = self.get_directory_snapshot()
        self.update_tree_view(set())

        # ç›£è¦–ã‚¿ã‚¤ãƒãƒ¼ã®è¨­å®šï¼ˆ5ç§’é–“éš”ï¼‰
        self.timer = QTimer(self)
        self.timer.setInterval(5000)
        self.timer.timeout.connect(self.check_for_changes)
        self.timer.start()

        # è¨­å®šã®æ›´æ–°ã‚’ç¢ºèªã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼
        self.settings_timer = QTimer(self)
        self.settings_timer.setInterval(5000)
        self.settings_timer.timeout.connect(self.check_app_directory)
        self.settings_timer.start()
        
        logger.debug("DirectoryWatchTab initialization complete")

    def show_debug_info(self):
        """ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹"""
        main_window = None
        settings_tab = None
        debug_info = []
        
        # è¦ªã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®æ¤œç´¢
        parent = self.parent()
        debug_info.append(f"Parent type: {type(parent).__name__}")
        
        while parent:
            debug_info.append(f"Checking parent: {type(parent).__name__}")
            if hasattr(parent, 'tabs'):
                main_window = parent
                debug_info.append(f"Found main window with {main_window.tabs.count()} tabs")
                break
            parent = parent.parent()
        
        # è¨­å®šã‚¿ãƒ–ã®æ¤œç´¢
        if main_window:
            for i in range(main_window.tabs.count()):
                tab = main_window.tabs.widget(i)
                tab_name = type(tab).__name__
                debug_info.append(f"Tab {i}: {tab_name} (obj_name: {tab.objectName()})")
                
                if tab_name == "SettingsTab" or tab.objectName() == "settings_tab":
                    settings_tab = tab
                    debug_info.append(f"Found settings tab at index {i}")
                    
                    # è¨­å®šã‚¿ãƒ–ã®å±æ€§ã‚’ç¢ºèª
                    if hasattr(settings_tab, 'get_app_directory'):
                        debug_info.append(f"get_app_directory method exists")
                        dir_value = settings_tab.get_app_directory()
                        debug_info.append(f"get_app_directory returns: {dir_value}")
                    else:
                        debug_info.append("get_app_directory method NOT found")
                        
                    if hasattr(settings_tab, 'app_dir_edit'):
                        debug_info.append(f"app_dir_edit property exists")
                        if hasattr(settings_tab.app_dir_edit, 'text'):
                            dir_text = settings_tab.app_dir_edit.text()
                            debug_info.append(f"app_dir_edit.text returns: {dir_text}")
                    else:
                        debug_info.append("app_dir_edit property NOT found")
        else:
            debug_info.append("Main window NOT found")
        
        # ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæƒ…å ±
        debug_info.append(f"Current directory: {self.directory}")
        
        # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§è¡¨ç¤º
        QMessageBox.information(self, "ãƒ‡ãƒãƒƒã‚°æƒ…å ±", "\n".join(debug_info))

    def get_app_directory(self):
        """è¨­å®šã‚¿ãƒ–ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—"""
        try:
            # mainWindowã¸ã®å‚ç…§ã‚’å–å¾—
            main_window = None
            parent = self.parent()
            logger.debug(f"Initial parent type: {type(parent).__name__}")
            
            while parent:
                logger.debug(f"Checking parent type: {type(parent).__name__}")
                if hasattr(parent, 'tabs'):
                    main_window = parent
                    logger.debug(f"Found main window with {main_window.tabs.count()} tabs")
                    break
                parent = parent.parent()
            
            if main_window:
                # è¨­å®šã‚¿ãƒ–ã‚’æ¢ã™
                for i in range(main_window.tabs.count()):
                    tab = main_window.tabs.widget(i)
                    logger.debug(f"Tab {i} type: {type(tab).__name__}, objectName: {tab.objectName()}")
                    
                    if tab.objectName() == "settings_tab" or type(tab).__name__ == "SettingsTab":
                        logger.debug(f"Found settings tab at index {i}")
                        
                        # get_app_directoryãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                        if hasattr(tab, 'get_app_directory'):
                            logger.debug("Using get_app_directory method from settings tab")
                            directory = tab.get_app_directory()
                            logger.debug(f"get_app_directory returned: {directory}")
                            if directory and os.path.exists(directory):
                                return directory
                        
                        # app_dir_editã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                        elif hasattr(tab, 'app_dir_edit'):
                            logger.debug("Using app_dir_edit from settings tab")
                            if hasattr(tab.app_dir_edit, 'text'):
                                directory = tab.app_dir_edit.text()
                                logger.debug(f"app_dir_edit.text returned: {directory}")
                                if directory and os.path.exists(directory):
                                    return directory
            else:
                logger.debug("Could not find main window")
                
        except Exception as e:
            logger.error(f"Error getting app directory: {e}")
            
        return None

    def check_app_directory(self):
        """ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ã‚’ç¢ºèª"""
        try:
            new_directory = self.get_app_directory()
            self.debug_label.setText(f"ãƒ‡ãƒãƒƒã‚°æƒ…å ±: ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª = {self.directory}, æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª = {new_directory}")
            logger.debug(f"check_app_directory - current: {self.directory}, new: {new_directory}")
            
            if new_directory and new_directory != self.directory and os.path.exists(new_directory):
                logger.debug(f"Updating directory from {self.directory} to {new_directory}")
                self.directory = new_directory
                self.watcher_thread.update_directory(new_directory)
                self.info_label.setText(f"ç›£è¦–ä¸­: {self.directory}")
                self.previous_snapshot = self.get_directory_snapshot()
                self.update_tree_view(set())
                self.update_directory_list(new_directory)
        except Exception as e:
            logger.error(f"Error checking app directory: {e}")

    def get_directory_snapshot(self):
        snapshot = {}
        try:
            for root, dirs, files in os.walk(self.directory):
                for name in files:
                    filepath = os.path.join(root, name)
                    rel_path = os.path.relpath(filepath, self.directory)
                    snapshot[rel_path] = os.path.getmtime(filepath)
        except Exception as e:
            logger.error(f"Error getting directory snapshot: {e}")
        return snapshot

    def check_for_changes(self):
        try:
            current_snapshot = self.get_directory_snapshot()
            new_files = set(current_snapshot.keys()) - set(self.previous_snapshot.keys())
            
            if new_files:
                logger.debug(f"Detected {len(new_files)} new files")
                self.previous_snapshot = current_snapshot
                self.update_tree_view(new_files)
        except Exception as e:
            logger.error(f"Error checking for changes: {e}")

    def update_tree_view(self, new_files):
        try:
            result = subprocess.run(
                ["tree", "-f", "--noreport"],
                capture_output=True,
                text=True